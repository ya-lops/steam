---
import AppLayout from "@/layouts/AppLayout.astro";
import Button from "@/components/ui/Button.astro";
import GameTag from "@/components/ui/GameTag.astro";

import WinOsLogo from "@icons/win-os-icon.svg";
import SteamLogo from "@icons/steam-logo.svg";

// Импортируем данные игр
import gamesData from "../../data/games.json";

// Функция для статической генерации всех страниц игр
export async function getStaticPaths() {
  return gamesData.map((game) => ({
    params: { game: game.id.toString() },
    props: { game },
  }));
}

// Получаем пропсы из getStaticPaths
const { game } = Astro.props;

// Курс доллара
const USD_TO_RUB = 80;

// Форматирование цены
const formatPrice = (priceInUSD: number) => {
  if (priceInUSD === 0) return "Бесплатно";
  const priceInRub = priceInUSD * USD_TO_RUB;
  return priceInRub.toFixed(1) + " ₽";
};

// Проверка скидки
const hasDiscount = game.price.discount && game.price.discount > 0;
const oldPrice = hasDiscount ? formatPrice(game.price.base) : null;
const newPrice = formatPrice(game.price.current);
const discountPercent = hasDiscount ? game.price.discount : null;

// Форматирование даты
const formatDate = (dateString: string) => {
  return new Date(dateString).toLocaleDateString("ru-RU", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};

const currentGame = game;
---

<AppLayout title={`${currentGame.name} — Steam :RE`} page="store">
  <main class="game-page">
    {/* Хедер с навигацией назад */}
    <div class="game-nav">
      <a href="/" class="back-link">← Вернуться в магазин</a>
    </div>

    {/* Основной блок игры */}
    <div class="game-container">
      {/* Левая колонка — главное изображение */}
      <div class="game-main-image">
        <img
          src={currentGame.images.header}
          alt={currentGame.name}
          class="main-header"
          fetchpriority="high"
          loading="eager"
        />
      </div>

      {/* Правая колонка — информация и покупка */}
      <div class="game-info">
        <h1 class="game-title typo-heading-xxlarge">{currentGame.name}</h1>

        <div class="game-meta">
          <div class="developer">
            <span class="label">Разработчик:</span>
            {currentGame.developer}
          </div>
          <div class="publisher">
            <span class="label">Издатель:</span>
            {currentGame.publisher}
          </div>
          <div class="release-date">
            <span class="label">Дата выхода:</span>
            {formatDate(currentGame.releaseDate)}
          </div>
        </div>

        {/* Блок с рейтингом */}
        {
          currentGame.ratings.score > 0 && (
            <div class="game-rating">
              <div class="rating-score">{currentGame.ratings.score}%</div>
              <div class="rating-count">
                {currentGame.ratings.totalPositive.toLocaleString()}{" "}
                положительных
              </div>
            </div>
          )
        }

        {/* Цена и покупка */}
        <div class="game-purchase">
          {
            currentGame.price.current === 0 ? (
              <div class="free-game">
                <span class="free-badge">Бесплатная игра</span>
                <Button>Играть</Button>
              </div>
            ) : (
              <div class="paid-game">
                {hasDiscount && (
                  <div class="discount-block">
                    <span class="discount-badge">-{discountPercent}%</span>
                    <span class="old-price">{oldPrice}</span>
                  </div>
                )}
                <div class="price-block">
                  <span
                    class="current-price"
                    class:list={hasDiscount && "with-discount"}
                  >
                    {newPrice}
                  </span>
                  <Button variant={hasDiscount ? "success" : "primary"}>
                    Купить
                  </Button>
                </div>
              </div>
            )
          }
        </div>

        {/* Жанры */}
        <div class="game-genres">
          <h3>Жанры:</h3>
          <div class="genres-list">
            {
              currentGame.genres.map((genre) => (
                <GameTag size="medium">{genre}</GameTag>
              ))
            }
          </div>
        </div>

        {/* Платформы */}
        <div class="game-platforms">
          <h3>Платформы:</h3>
          <div class="platforms-list">
            {currentGame.platforms.includes("windows") && <WinOsLogo />}
            {
              currentGame.platforms.includes("mac") && (
                <span class="platform">macOS</span>
              )
            }
            {
              currentGame.platforms.includes("steamos") && (
                <span class="platform">SteamOS</span>
              )
            }
            {
              currentGame.platforms.includes("playstation") && (
                <span class="platform">PlayStation</span>
              )
            }
            {
              currentGame.platforms.includes("xbox") && (
                <span class="platform">Xbox</span>
              )
            }
          </div>
        </div>

        {/* Особенности */}
        {
          Object.entries(currentGame.features).some(([_, value]) => value) && (
            <div class="game-features">
              <h3>Особенности:</h3>
              <ul class="features-list">
                {currentGame.features.singlePlayer && <li>Одиночная игра</li>}
                {currentGame.features.multiplayer && <li>Мультиплеер</li>}
                {currentGame.features.coop && <li>Кооператив</li>}
                {currentGame.features.pvp && <li>PvP</li>}
                {currentGame.features.crossPlatform && <li>Кросс-платформа</li>}
              </ul>
            </div>
          )
        }
      </div>
    </div>

    {/* Описание игры */}
    <div class="game-description-section">
      <h2>Описание</h2>
      <p class="game-description-full">{currentGame.description.full}</p>
    </div>

    {/* Галерея скриншотов */}
    {
      currentGame.screenshots.some((s) => s) && (
        <div class="game-screenshots">
          <h2>Скриншоты</h2>
          <div class="screenshots-grid">
            {currentGame.screenshots.filter(Boolean).map((screenshot) => (
              <div class="screenshot-item">
                <img src={screenshot} alt={`${currentGame.name} скриншот`} loading="lazy"/>
              </div>
            ))}
          </div>
        </div>
      )
    }

    {/* Ссылка на Steam */}
    <div class="steam-link">
      <a href={currentGame.steam.url} target="_blank" rel="noopener noreferrer">
        <SteamLogo /> Смотреть в Steam
      </a>
    </div>
  </main>
</AppLayout>

<style>
  .game-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
  }

  .game-nav {
    margin-bottom: 30px;
  }

  .back-link {
    color: var(--steam-color-text-secondary);
    text-decoration: none;

    &:hover {
      color: var(--steam-color-primary);
    }
  }

  .game-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    margin-bottom: 40px;
  }

  .game-main-image {
    img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }
  }

  .game-info {
    background: var(--steam-color-bg-surface-10);
    padding: 30px;
    border-radius: 8px;
  }

  .game-title {
    margin-bottom: 20px;
    color: var(--steam-color-text-primary);
  }

  .game-meta {
    margin-bottom: 25px;
    color: var(--steam-color-text-secondary);
    font-size: 0.95rem;

    .label {
      color: var(--steam-color-text-muted);
      margin-right: 5px;
    }

    > div {
      margin-bottom: 8px;
    }
  }

  .game-rating {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    padding: 15px;
    background: var(--steam-color-bg-highlight);
    border-radius: 6px;

    .rating-score {
      font-size: 2rem;
      font-weight: bold;
      color: #66c0f4;
    }

    .rating-count {
      color: var(--steam-color-text-secondary);
    }
  }

  .game-purchase {
    margin-bottom: 30px;
    padding: 20px;
    background: var(--steam-color-bg-highlight);
    border-radius: 6px;

    .free-game {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .free-badge {
      background: var(--steam-color-accent-success);
      padding: 5px 10px;
      border-radius: 3px;
      font-weight: bold;
    }

    .paid-game {
      .discount-block {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }

      .discount-badge {
        background: var(--steam-color-accent-success);
        padding: 5px 10px;
        border-radius: 3px;
        font-weight: bold;
      }

      .old-price {
        text-decoration: line-through;
        color: var(--steam-color-text-muted);
      }

      .price-block {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .current-price {
        font-size: 1.5rem;
        font-weight: bold;

        &.with-discount {
          color: var(--steam-color-accent-success);
        }
      }
    }
  }

  .game-genres,
  .game-platforms,
  .game-features {
    margin-bottom: 25px;

    h3 {
      font-size: 1rem;
      color: var(--steam-color-text-muted);
      margin-bottom: 10px;
    }
  }

  .genres-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .platforms-list {
    display: flex;
    gap: 15px;
    align-items: center;
  }

  .features-list {
    list-style: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;

    li {
      background: var(--steam-color-bg-surface-10);
      padding: 5px 12px;
      border-radius: 3px;
      font-size: 0.9rem;
    }
  }

  .game-description-section {
    margin-bottom: 40px;

    h2 {
      margin-bottom: 15px;
      font-size: 1.5rem;
    }
  }

  .game-description-full {
    line-height: 1.7;
    color: var(--steam-color-text-primary);
    white-space: pre-line;
  }

  .game-screenshots {
    margin-bottom: 40px;

    h2 {
      margin-bottom: 20px;
    }
  }

  .screenshots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
  }

  .screenshot-item {
    border-radius: 6px;
    overflow: hidden;
    aspect-ratio: 16/9;

    img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s;

      &:hover {
        transform: scale(1.05);
      }
    }
  }

  .game-requirements {
    margin-bottom: 40px;

    h2 {
      margin-bottom: 20px;
    }
  }

  .requirements-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
  }

  .requirements-min,
  .requirements-rec {
    background: var(--steam-color-bg-surface-10);
    padding: 20px;
    border-radius: 6px;

    h3 {
      margin-bottom: 15px;
      color: var(--steam-color-text-muted);
    }

    ul {
      list-style: none;
      padding: 0;

      li {
        margin-bottom: 10px;
        font-size: 0.95rem;
        line-height: 1.5;
      }
    }
  }

  .steam-link {
    text-align: center;
    margin-top: 40px;

    a {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      background: var(--steam-color-bg-surface-10);
      padding: 15px 30px;
      border-radius: 6px;
      text-decoration: none;
      color: var(--steam-color-text-primary);
      transition: background 0.2s;

      &:hover {
        background: var(--steam-color-bg-highlight);
      }

      svg {
        width: 24px;
        height: 24px;
      }
    }
  }

  @media (max-width: 768px) {
    .game-container {
      grid-template-columns: 1fr;
    }

    .requirements-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
